_format_version: "3.0"
_transform: true

services:
  # --- IAM Service ---
  - name: iam-service
    url: http://iam-service:8000
    routes:
      - name: iam-route
        paths:
          - /iam
        strip_path: true
    plugins:
      - name: rate-limiting
        config:
          second: 10
          minute: 500
          policy: local

  # --- Catalog Service ---
  - name: catalog-service
    url: http://catalog-service:8000
    routes:
      - name: catalog-route
        paths:
          - /catalog
        strip_path: true

  # --- Finance Service ---
  - name: finance-service
    url: http://finance-service:8000
    routes:
      - name: finance-route
        paths:
          - /finance
        strip_path: true

  # --- Membership Service ---
  - name: membership-service
    url: http://membership-service:8000
    routes:
      - name: membership-route
        paths:
          - /membership
        strip_path: true

  # --- Chat Service ---
  - name: chat-service
    url: http://chat-service:8000
    routes:
      - name: chat-route
        paths:
          - /chat
        strip_path: true

  # --- Workflow Service ---
  - name: workflow-service
    url: http://workflow-service:8000
    routes:
      - name: workflow-route
        paths:
          - /workflow
        strip_path: true

  # --- Notifications Service ---
  - name: notifications-service
    url: http://notifications-service:8000
    routes:
      - name: notifications-route
        paths:
          - /notifications
        strip_path: true

  # --- Analytics Service ---
  - name: analytics-service
    url: http://analytics-service:8000
    routes:
      - name: analytics-route
        paths:
          - /analytics
        strip_path: true

  # --- Global Health ---
  - name: global-health
    url: http://iam-service:8000/health
    routes:
      - name: health-route
        paths:
          - /health

plugins:
  - name: prometheus
  - name: file-log
    config:
      path: /dev/stdout
  - name: http-log
    config:
      http_endpoint: "http://analytics-service:8000/ingest"
      method: POST
      timeout: 1000
      keepalive: 60000
  - name: cors
    config:
      origins: ["*"]
      methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"]
      headers:
        [
          "Accept",
          "Accept-Version",
          "Content-Length",
          "Content-MD5",
          "Content-Type",
          "Date",
          "Authorization",
        ]
      exposed_headers: ["X-Auth-Token"]
      credentials: true
      max_age: 3600
